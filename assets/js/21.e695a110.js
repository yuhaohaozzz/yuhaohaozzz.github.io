(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{365:function(s,a,n){"use strict";n.r(a);var t=n(0),e=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),a("p",[s._v("在产品的CICD中，经常会用到GitlabCI来执行并发任务，例如我们在适配软件版本时，需要针对不同的操作系统(18.04/20.04/22.04)适配多Python版本(python3.6/python3.7/python3.8/python3.9)，这里就涉及了12个并行的PIPILINE。\n按照传统方案，我们硬编码ubuntu和python版本来定义12个不同的Job，这里对少量的并行任务还是可行的，对于这种并发数量多的任务，则增加了极大的配置和维护成本，同时CI文件会变得极为冗长。\n这里可以使用GitlabCI提供的并行矩阵(parallel matrix)，来简化多个并行任务的配置")]),s._v(" "),a("h2",{attrs:{id:"parallel-matrix-介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#parallel-matrix-介绍"}},[s._v("#")]),s._v(" parallel:matrix 介绍")]),s._v(" "),a("p",[s._v("parallel 可以配置并行任务的作业实例数，parallel 关键字创建并行运行的同一作业的 N 个实例。 它们从 job_name 1/N 到 job_name N/N 按顺序命名：")]),s._v(" "),a("p",[a("strong",[s._v("parallel")]),s._v(" 示例：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("# 此示例创建了 5 个并行运行的作业，名为 test 1/5 到 test 5/5。\ntest:\n  script: rspec\n  parallel: 5\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("使用 parallel:matrix 在单个流水线中并行运行作业多次，但对于作业的每个实例使用不同的变量值。\n"),a("strong",[s._v("前提：必须存在多个 runner，或者必须将单个 runner 配置为同时运行多个作业。")]),s._v(" "),a("strong",[s._v("关键字类型")]),s._v("：作业关键字。您只能将其用作作业的一部分。\n"),a("strong",[s._v("可能的输入")]),s._v("：变量哈希数组：")]),s._v(" "),a("ul",[a("li",[s._v("变量名只能使用数字、字母和下划线 (_)。")]),s._v(" "),a("li",[s._v("值必须是字符串或字符串数组。")]),s._v(" "),a("li",[s._v("排列数不能超过 200。")])]),s._v(" "),a("p",[a("strong",[s._v("parallel:matrix")]),s._v(" 示例：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("deploystacks:\n  stage: deploy\n  script:\n    - bin/deploy\n  parallel:\n    matrix:\n      - PROVIDER: aws\n        STACK:\n          - monitoring\n          - app1\n          - app2\n      - PROVIDER: ovh\n        STACK: [monitoring, backup, app]\n      - PROVIDER: [gcp, vultr]\n        STACK: [data, processing]\n  environment: $PROVIDER/$STACK\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("p",[s._v("上面的示例生成 10 个并行的 deploystacks 作业，每个作业具有不同的 PROVIDER 和 STACK 值：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("deploystacks: [aws, monitoring]\ndeploystacks: [aws, app1]\ndeploystacks: [aws, app2]\ndeploystacks: [ovh, monitoring]\ndeploystacks: [ovh, backup]\ndeploystacks: [ovh, app]\ndeploystacks: [gcp, data]\ndeploystacks: [gcp, processing]\ndeploystacks: [vultr, data]\ndeploystacks: [vultr, processing]\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[a("strong",[s._v("其它说明：")]),s._v("\nparallel:matrix 作业将变量值添加到作业名称以区分作业，但较大的值可能会导致名称超出限制。")]),s._v(" "),a("ul",[a("li",[s._v("作业名称必须包含 255 个字符或更少。")]),s._v(" "),a("li",[s._v("使用 needs 时，作业名称不得超过 128 个字符")])])])}),[],!1,null,null,null);a.default=e.exports}}]);