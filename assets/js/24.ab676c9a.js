(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{363:function(s,a,n){"use strict";n.r(a);var t=n(0),e=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),a("p",[s._v("在我们维护的业务集群中，有些服务如监控相关在部署时没有采用高可用的方案，对接的存储使用了openebs hostpath或者其它的存储方案，并未支持多副本，这样会导致当监控服务所在的节点异常后，对应的prometheus或者grafana等持久化数据的服务无法恢复。这里由于设备的磁盘等相关限制，无法针对当前环境部署新的支持多副本的分布式存储。")]),s._v(" "),a("p",[s._v("基于此问题，我们考虑对于监控这种非核心的业务，直接接入外部的存储，考虑到外部存储可选择的较多如NFS，Ceph，Gluster等。对于监控这种服务不涉及共享PV的读写，因此我们优先选择块存储来提高性能。考虑需要存储数据的高可用，我们选择分布式存储，保证后续的可扩展性，这里我们选择Ceph的RBD进行测试。")]),s._v(" "),a("h2",{attrs:{id:"ceph支持k8s存储介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ceph支持k8s存储介绍"}},[s._v("#")]),s._v(" ceph支持k8s存储介绍")]),s._v(" "),a("p",[s._v("Ceph支持Kubernetes存储有两种类型：")]),s._v(" "),a("ul",[a("li",[s._v("Cephfs")]),s._v(" "),a("li",[s._v("Ceph RBD")])]),s._v(" "),a("h2",{attrs:{id:"ceph集群部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ceph集群部署"}},[s._v("#")]),s._v(" ceph集群部署")]),s._v(" "),a("ol",[a("li",[s._v("部署ceph集群")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里我们测试只有一台机器，因此我们部署单机。详细部署可以直接参考官网文档")]),s._v("\n$ hostnamectl set-hostname ceph01\n$ systemctl disable "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--now")]),s._v(" firewalld\n$ yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" epel* "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v(" \n$ yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v(" python3 docker-ce docker-ce-cli ceph-common ceph\n$ systemctl restart "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" systemctl "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("enable")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v("\n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://github.com/ceph/ceph/raw/v15.2.17/src/cephadm/cephadm\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x cephadm "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" cephadm /usr/bin/\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" quay.io /usr/bin/cephadm "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("awk")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'{print $3}'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("xargs")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" pull "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n$ cephadm bootstrap --mon-ip "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.8")]),s._v(".29.87\n$ cephadm add-repo "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--release")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.2")]),s._v(".17\n$ ceph orch "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("host")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" ceph01\n$ ceph orch apply osd --all-available-devices\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意, 加到OSD的磁盘不能存在分区，可以使用下面的命名进行格式化")]),s._v("\n$ ceph orch device zap ceph01 /dev/sdb "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--force")]),s._v("\n$ ceph orch device zap ceph01 /dev/sdc "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--force")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置默认的存储池副本数为2")]),s._v("\n$ ceph config "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" global osd_pool_default_size "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意, 对于单机我们可以设置故障域为OSD，从而实现多副本")]),s._v("\n$ ceph osd getcrushmap "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" crushmap.encode\n$ crushtool "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" crushmap.encode "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" crushmap.decode\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" crushmap.decode\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rules")]),s._v("\nrule replicated_rule "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" replicated\n\tmin_size "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\tmax_size "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v("\n\tstep take default\n\tstep chooseleaf firstn "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("type")]),s._v(" osd    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里修改host为osd")]),s._v("\n\tstep emit\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里注入我们修改过故障域的crushmap")]),s._v("\n$ crushtool "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" crushmap.decode "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" crushmap_new\n$ ceph osd setcrushmap "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" crushmap_new\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("查看集群状态：")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph -v ")]),s._v("\nceph version "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15.2")]),s._v(".17 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("8a82819d84cf884bd39c17e3236e0632ac146dc4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" octopus "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("stable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph -s")]),s._v("\n  cluster:\n    id:     3c4a4956-ecf7-11ee-b392-b49691393a30\n    health: HEALTH_OK\n\n  services:\n    mon: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" daemons, quorum ceph01 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("age 4d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    mgr: ceph01.puytzc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("active, since 4d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    osd: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" osds: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" up "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 4d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("since 4d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n  data:\n    pools:   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" pools, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("33")]),s._v(" pgs\n    objects: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("62")]),s._v(" objects, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v(" MiB\n    usage:   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.2")]),s._v(" GiB used, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" TiB / "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" TiB avail\n    pgs:     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("33")]),s._v(" active+clean\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("ol",{attrs:{start:"3"}},[a("li",[s._v("创建和初始化RBD存储池")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("$ ceph osd pool create kubernetes "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),s._v(" \n$ rbd pool init kubernetes\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"配置ceph-csi-在ceph集群操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置ceph-csi-在ceph集群操作"}},[s._v("#")]),s._v(" 配置ceph-csi（在ceph集群操作）")]),s._v(" "),a("ol",[a("li",[s._v("为kubernetes和ceph-csi创建一个新用户(也可以使用默认的client.admin用户)")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("$ ceph auth get-or-create client.kubernetes mon "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'profile rbd'")]),s._v(" osd "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'profile rbd pool=kubernetes'")]),s._v(" mgr "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'profile rbd pool=kubernetes'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("client.kubernetes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    key "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("AQD9o0Fd6hQRChAAt7fMaSZXduT3NWEqylNpmg")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("创建ceph-csi configmap\n"),a("strong",[s._v("在ceph集群执行如下命令，获取ceph集群的fsid（对应fsid行后面字符串）和mon地址（最后一行6789端口的地址）")])])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@ceph01 ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ceph mon dump")]),s._v("\ndumped monmap epoch "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nepoch "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nfsid 3c4a4956-ecf7-11ee-b392-b49691393a30\nlast_changed "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2024")]),s._v("-03-28T11:35:16.640961+0000\ncreated "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2024")]),s._v("-03-28T11:35:16.640961+0000\nmin_mon_release "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("octopus"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("v2:10.8.29.87:3300/0,v1:10.8.29.87:6789/0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" mon.ceph01\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[a("strong",[s._v("在k8s集群执行如下命令，创建ceph集群的configmap")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF"),a("span",{pre:!0,attrs:{class:"token bash punctuation"}},[s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" csi-config-map.yaml")]),s._v('\n---\napiVersion: v1\nkind: ConfigMap\ndata:\n  config.json: |-\n    [\n      {\n        "clusterID": "3c4a4956-ecf7-11ee-b392-b49691393a30",\n        "monitors": [\n          "10.8.29.87:6789"\n        ]\n      }\n    ]\nmetadata:\n  name: ceph-csi-config\nEOF')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 应用yaml文件")]),s._v("\n$ kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" csi-config-map.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[a("strong",[s._v("创建KMS provider所使用的ConfigMap文件")]),s._v("\n最新版本的ceph-csi还需要一个额外的ConfigMap对象来定义密钥管理服务(KMS)提供程序的详细信息。如果没有设置KMS，在csi-kms-config-map中放置一个空配置即可")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF"),a("span",{pre:!0,attrs:{class:"token bash punctuation"}},[s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" csi-kms-config-map.yaml")]),s._v("\n---\napiVersion: v1\nkind: ConfigMap\ndata:\n  config.json: |-\n    {}\nmetadata:\n  name: ceph-csi-encryption-kms-config\nEOF")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 应用yaml文件")]),s._v("\n$ kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" csi-kms-config-map.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[a("strong",[s._v("创建保存Ceph配置的ConfigMap")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF"),a("span",{pre:!0,attrs:{class:"token bash punctuation"}},[s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ceph-config-map.yaml")]),s._v("\n---\napiVersion: v1\nkind: ConfigMap\ndata:\n  ceph.conf: |\n    [global]\n    auth_cluster_required = cephx\n    auth_service_required = cephx\n    auth_client_required = cephx\n  # keyring is a required key and its value should be empty\n  keyring: |\nmetadata:\n  name: ceph-config\nEOF")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 应用yaml文件")]),s._v("\n$ kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" ceph-config-map.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[a("strong",[s._v("创建ceph-csi cephx secret")]),s._v("\nceph-csi需要cephx凭据才能与Ceph集群通信")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里可以直接用client.admin的用户，具体查看可以在ceph集群执行```ceph auth list```查看")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF"),a("span",{pre:!0,attrs:{class:"token bash punctuation"}},[s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" csi-rbd-secret.yaml")]),s._v("\n---\napiVersion: v1\nkind: Secret\nmetadata:\n  name: csi-rbd-secret\n  namespace: default\nstringData:\n  userID: admin\n  userKey: AQDzVQVmXmBIOhAA6GdWny0CNISY/6jnmVCrNA==\nEOF")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 应用yaml文件")]),s._v("\n$ kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" csi-rbd-secret.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[a("strong",[s._v("配置ceph-csi plugins")]),s._v("\n创建需要的ServiceAccount和RBAC ClusterRole/ClusterRoleBinding")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("$ kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" https://raw.githubusercontent.com/ceph/ceph-csi/master/deploy/rbd/kubernetes/csi-provisioner-rbac.yaml\n$ kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" https://raw.githubusercontent.com/ceph/ceph-csi/master/deploy/rbd/kubernetes/csi-nodeplugin-rbac.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[a("strong",[s._v("创建ceph-csi provisioner 和node plugins")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 由于yaml文件里面的镜像是国外的地址源，因此这里改成自己的镜像地址")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://raw.githubusercontent.com/ceph/ceph-csi/master/deploy/rbd/kubernetes/csi-rbdplugin-provisioner.yaml\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://raw.githubusercontent.com/ceph/ceph-csi/master/deploy/rbd/kubernetes/csi-rbdplugin.yaml\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意将原始文件的镜像地址修改为下面阿里云镜像仓库的地址")]),s._v("\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-R")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"image:"')]),s._v(" * \ncsi-rbdplugin-provisoner.yaml:          image: registry.cn-hangzhou.aliyuncs.com/postkarte/cephcsi:canary\ncsi-rbdplugin-provisoner.yaml:          image: registry.cn-hangzhou.aliyuncs.com/google_containers/csi-provisioner:v4.0.0\ncsi-rbdplugin-provisoner.yaml:          image: registry.cn-hangzhou.aliyuncs.com/google_containers/csi-snapshotter:v7.0.0\ncsi-rbdplugin-provisoner.yaml:          image: registry.cn-hangzhou.aliyuncs.com/google_containers/csi-attacher:v4.5.0\ncsi-rbdplugin-provisoner.yaml:          image: registry.cn-hangzhou.aliyuncs.com/google_containers/csi-resizer:v1.10.0\ncsi-rbdplugin-provisoner.yaml:          image: registry.aliyuncs.com/postkarte/cephcsi:canary\ncsi-rbdplugin-provisoner.yaml:          image: registry.aliyuncs.com/postkarte/cephcsi:canary\ncsi-rbdplugin.yaml:          image: registry.cn-hangzhou.aliyuncs.com/postkarte/cephcsi:canary\ncsi-rbdplugin.yaml:          image: registry.cn-hangzhou.aliyuncs.com/google_containers/csi-node-driver-registrar:v2.10.0\ncsi-rbdplugin.yaml:          image: registry.cn-hangzhou.aliyuncs.com/postkarte/cephcsi:canary\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 应用yaml文件")]),s._v("\n$ kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" csi-rbdplugin-provisioner.yaml \n$ kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" csi-rbdplugin.yaml \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[a("strong",[s._v("创建storageclass")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF"),a("span",{pre:!0,attrs:{class:"token bash punctuation"}},[s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" csi-rbd-sc.yaml")]),s._v("\n---\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n   name: csi-rbd-sc\nprovisioner: rbd.csi.ceph.com\nparameters:\n   clusterID: 3c4a4956-ecf7-11ee-b392-b49691393a30  # 注意修改集群的fsid\n   pool: kubernetes\n   imageFeatures: layering\n   csi.storage.k8s.io/provisioner-secret-name: csi-rbd-secret\n   csi.storage.k8s.io/provisioner-secret-namespace: default\n   csi.storage.k8s.io/controller-expand-secret-name: csi-rbd-secret\n   csi.storage.k8s.io/controller-expand-secret-namespace: default\n   csi.storage.k8s.io/node-stage-secret-name: csi-rbd-secret\n   csi.storage.k8s.io/node-stage-secret-namespace: default\nreclaimPolicy: Delete\nallowVolumeExpansion: true\nmountOptions:\n   - discard\nEOF")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 应用yaml文件")]),s._v("\n$ kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" csi-rbd-sc.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("p",[a("strong",[s._v("查看ceph csi插件状态")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看插件POD运行状态")]),s._v("\n$ kubectl get pod\nNAME                                         READY   STATUS    RESTARTS   AGE\ncsi-rbdplugin-5vvdc                          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("/3     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          15h\ncsi-rbdplugin-provisioner-6977c6b67d-8jh6w   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("/7     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          15h\n$ 查看StorageClass\n$ kubectl get sc\nNAME                          PROVISIONER                    RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE\ncsi-rbd-sc                    rbd.csi.ceph.com               Delete          Immediate              "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("                   15h\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h2",{attrs:{id:"测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[s._v("#")]),s._v(" 测试")]),s._v(" "),a("ol",[a("li",[s._v("创建一个简单的POD进行测试")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" test-pvc.yaml\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: raw-block-pvc\nspec:\n  accessModes:\n    - ReadWriteOnce\n  volumeMode: Filesystem\n  resources:\n    requests:\n      storage: 1Gi\n  storageClassName: csi-rbd-sc\n$ kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" test-pvc.yaml\n\n$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" test-pod.yaml\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: csi-rbd-demo-pod\nspec:\n  containers:\n    - name: web-server\n      image: nginx\n      volumeMounts:\n        - name: mypvc\n          mountPath: /var/lib/www/html\n  volumes:\n    - name: mypvc\n      persistentVolumeClaim:\n        claimName: raw-block-pvc\n$ kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" test-pod.yaml\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看创建的POD和PVC")]),s._v("\n$ kubectl get pod\nNAME                                         READY   STATUS    RESTARTS   AGE\ncsi-rbd-demo-pod                             "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          78m\n$ kubectl get pvc\nNAME            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nraw-block-pvc   Bound    pvc-2966202c-5903-494d-a3cd-545e0595bcf9   1Gi        RWO            csi-rbd-sc     78m\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("prometheus测试")])]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# helm 部署")]),s._v("\n$ helm "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" prometheus  ./kube-prometheus "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" prometheus-values.yaml "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--namespace")]),s._v(" monitoring\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看pod和pvc")]),s._v("\n$ kubectl get pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" monitoring\nNAME                                             READY   STATUS    RESTARTS   AGE\nalertmanager-prometheus-alertmanager-0           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          67m\nprometheus-blackbox-exporter-6686495fc-ft7fr     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          67m\nprometheus-kube-state-metrics-5b77fdf784-2724j   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          67m\nprometheus-node-exporter-tm2cc                   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          67m\nprometheus-operator-69c67867b6-72ll7             "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          67m\nprometheus-prometheus-prometheus-0               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          67m\n$ kubectl get pvc "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" monitoring\nNAME                                                                             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE\nalertmanager-prometheus-alertmanager-db-alertmanager-prometheus-alertmanager-0   Bound    pvc-3a6b531f-4f58-43f9-9716-7c9bfa8ae767   8Gi        RWO            csi-rbd-sc     67m\nprometheus-prometheus-prometheus-db-prometheus-prometheus-prometheus-0           Bound    pvc-a4ced6a9-f7f6-432f-b1a7-bcb81d932da9   8Gi        RWO            csi-rbd-sc     67m\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h2",{attrs:{id:"question"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#question"}},[s._v("#")]),s._v(" Question")]),s._v(" "),a("p",[s._v("1.可以查看的文档链接？")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://docs.ceph.com/en/latest/rbd/rbd-kubernetes/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Ceph Csi部署"),a("OutboundLink")],1),s._v(" "),a("a",{attrs:{href:"https://github.com/ceph/ceph-csi#support-matrix",target:"_blank",rel:"noopener noreferrer"}},[s._v("Ceph Csi插件"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("2.ceph csi和k8s，ceph集群兼容版本?")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("Plugin")]),s._v(" "),a("th",[s._v("Features")]),s._v(" "),a("th",[s._v("Feature Status")]),s._v(" "),a("th",[s._v("CSI Driver Version")]),s._v(" "),a("th",[s._v("CSI Spec Version")]),s._v(" "),a("th",[s._v("Ceph Cluster Version")]),s._v(" "),a("th",[s._v("Kubernetes Version")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("RBD")]),s._v(" "),a("td",[s._v("Dynamically provision, de-provision Block mode RWO volume")]),s._v(" "),a("td",[s._v("GA")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.14.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Dynamically provision, de-provision Block mode RWX volume")]),s._v(" "),a("td",[s._v("GA")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.14.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Dynamically provision, de-provision Block mode RWOP volume")]),s._v(" "),a("td",[s._v("Alpha")]),s._v(" "),a("td",[s._v(">= v3.5.0")]),s._v(" "),a("td",[s._v(">= v1.5.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.22.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Dynamically provision, de-provision File mode RWO volume")]),s._v(" "),a("td",[s._v("GA")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.14.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Dynamically provision, de-provision File mode RWOP volume")]),s._v(" "),a("td",[s._v("Alpha")]),s._v(" "),a("td",[s._v(">= v3.5.0")]),s._v(" "),a("td",[s._v(">= v1.5.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.22.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Provision File Mode ROX volume from snapshot")]),s._v(" "),a("td",[s._v("Alpha")]),s._v(" "),a("td",[s._v(">= v3.0.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.17.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Provision File Mode ROX volume from another volume")]),s._v(" "),a("td",[s._v("Alpha")]),s._v(" "),a("td",[s._v(">= v3.0.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.16.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Provision Block Mode ROX volume from snapshot")]),s._v(" "),a("td",[s._v("Alpha")]),s._v(" "),a("td",[s._v(">= v3.0.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.17.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Provision Block Mode ROX volume from another volume")]),s._v(" "),a("td",[s._v("Alpha")]),s._v(" "),a("td",[s._v(">= v3.0.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.16.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Creating and deleting snapshot")]),s._v(" "),a("td",[s._v("GA")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.17.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Provision volume from snapshot")]),s._v(" "),a("td",[s._v("GA")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.17.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Provision volume from another volume")]),s._v(" "),a("td",[s._v("GA")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.16.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Expand volume")]),s._v(" "),a("td",[s._v("Beta")]),s._v(" "),a("td",[s._v(">= v2.0.0")]),s._v(" "),a("td",[s._v(">= v1.1.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.15.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Volume/PV Metrics of File Mode Volume")]),s._v(" "),a("td",[s._v("GA")]),s._v(" "),a("td",[s._v(">= v1.2.0")]),s._v(" "),a("td",[s._v(">= v1.1.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.15.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Volume/PV Metrics of Block Mode Volume")]),s._v(" "),a("td",[s._v("GA")]),s._v(" "),a("td",[s._v(">= v1.2.0")]),s._v(" "),a("td",[s._v(">= v1.1.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.21.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Topology Aware Provisioning Support")]),s._v(" "),a("td",[s._v("Alpha")]),s._v(" "),a("td",[s._v(">= v2.1.0")]),s._v(" "),a("td",[s._v(">= v1.1.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.14.0")])]),s._v(" "),a("tr",[a("td",[s._v("CephFS")]),s._v(" "),a("td",[s._v("Dynamically provision, de-provision File mode RWO volume")]),s._v(" "),a("td",[s._v("GA")]),s._v(" "),a("td",[s._v(">= v1.1.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.14.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Dynamically provision, de-provision File mode RWX volume")]),s._v(" "),a("td",[s._v("GA")]),s._v(" "),a("td",[s._v(">= v1.1.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.14.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Dynamically provision, de-provision File mode ROX volume")]),s._v(" "),a("td",[s._v("Alpha")]),s._v(" "),a("td",[s._v(">= v3.0.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.14.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Dynamically provision, de-provision File mode RWOP volume")]),s._v(" "),a("td",[s._v("Alpha")]),s._v(" "),a("td",[s._v(">= v3.5.0")]),s._v(" "),a("td",[s._v(">= v1.5.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.22.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Creating and deleting snapshot")]),s._v(" "),a("td",[s._v("GA")]),s._v(" "),a("td",[s._v(">= v3.1.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.17.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Provision volume from snapshot")]),s._v(" "),a("td",[s._v("GA")]),s._v(" "),a("td",[s._v(">= v3.1.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.17.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Provision volume from another volume")]),s._v(" "),a("td",[s._v("GA")]),s._v(" "),a("td",[s._v(">= v3.1.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.16.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Expand volume")]),s._v(" "),a("td",[s._v("Beta")]),s._v(" "),a("td",[s._v(">= v2.0.0")]),s._v(" "),a("td",[s._v(">= v1.1.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.15.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Volume/PV Metrics of File Mode Volume")]),s._v(" "),a("td",[s._v("GA")]),s._v(" "),a("td",[s._v(">= v1.2.0")]),s._v(" "),a("td",[s._v(">= v1.1.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.15.0")])]),s._v(" "),a("tr",[a("td",[s._v("NFS")]),s._v(" "),a("td",[s._v("Dynamically provision, de-provision File mode RWO volume")]),s._v(" "),a("td",[s._v("Alpha")]),s._v(" "),a("td",[s._v(">= v3.6.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.14.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Dynamically provision, de-provision File mode RWX volume")]),s._v(" "),a("td",[s._v("Alpha")]),s._v(" "),a("td",[s._v(">= v3.6.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.14.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Dynamically provision, de-provision File mode ROX volume")]),s._v(" "),a("td",[s._v("Alpha")]),s._v(" "),a("td",[s._v(">= v3.6.0")]),s._v(" "),a("td",[s._v(">= v1.0.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.14.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Dynamically provision, de-provision File mode RWOP volume")]),s._v(" "),a("td",[s._v("Alpha")]),s._v(" "),a("td",[s._v(">= v3.6.0")]),s._v(" "),a("td",[s._v(">= v1.5.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.22.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Expand volume")]),s._v(" "),a("td",[s._v("Alpha")]),s._v(" "),a("td",[s._v(">= v3.7.0")]),s._v(" "),a("td",[s._v(">= v1.1.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.15.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Creating and deleting snapshot")]),s._v(" "),a("td",[s._v("Alpha")]),s._v(" "),a("td",[s._v(">= v3.7.0")]),s._v(" "),a("td",[s._v(">= v1.1.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.17.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Provision volume from snapshot")]),s._v(" "),a("td",[s._v("Alpha")]),s._v(" "),a("td",[s._v(">= v3.7.0")]),s._v(" "),a("td",[s._v(">= v1.1.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.17.0")])]),s._v(" "),a("tr",[a("td"),s._v(" "),a("td",[s._v("Provision volume from another volume")]),s._v(" "),a("td",[s._v("Alpha")]),s._v(" "),a("td",[s._v(">= v3.7.0")]),s._v(" "),a("td",[s._v(">= v1.1.0")]),s._v(" "),a("td",[s._v("Pacific (>=v16.2.0)")]),s._v(" "),a("td",[s._v(">= v1.16.0")])])])])])}),[],!1,null,null,null);a.default=e.exports}}]);