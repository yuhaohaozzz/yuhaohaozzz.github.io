(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{363:function(s,a,n){"use strict";n.r(a);var e=n(0),t=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),a("p",[s._v("目前有比较多的开源运维平台，内置了监控告警服务，我们可以直接结合实际的业务进行部署使用，例如蓝鲸平台/SPUG平台等。这里我们主要介绍下，在自建的k8s集群或者其它分布式系统中，如何快速搭建自己的监控告警平台。")]),s._v(" "),a("p",[s._v("当前比较主流的监控告警平台，很多都是基于Prometheus + Grafana + AlertManager的方案来实现，当前也可以采用 "),a("a",{attrs:{href:"https://github.com/VictoriaMetrics/VictoriaMetrics",target:"_blank",rel:"noopener noreferrer"}},[s._v("VictoriaMetrics"),a("OutboundLink")],1),s._v("的监控方案，这里也是目前我这边在运维大规模集群采用的比较多的监控方案。当前比较传统的方案Zabbix/Nagios这些根据实际业务的需求也可以采用，这里就不再进行介绍。")]),s._v(" "),a("p",[s._v("下面我们具体介绍下Prometheus + Grafana + AlertManager的告警体系")]),s._v(" "),a("h2",{attrs:{id:"promtheus监控体系介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#promtheus监控体系介绍"}},[s._v("#")]),s._v(" promtheus监控体系介绍")]),s._v(" "),a("h3",{attrs:{id:"promtheus监控体系架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#promtheus监控体系架构"}},[s._v("#")]),s._v(" promtheus监控体系架构")]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/monitor/1.png",alt:""}})]),s._v(" "),a("ul",[a("li",[s._v("prometheus server\n这里prometheus server是prometheus的核心，相当于时间序列数据库，负责从"),a("code",[s._v("exporter")]),s._v("拉取和存储监控数据，并提供一套灵活的查询语言（PromQL）供用户使用。prometheus server本身也提供了自己的metrics接口。")]),s._v(" "),a("li",[s._v("alertmanager\n这里alertmanager是报警组件（prometheus配置报警事件的采集规则，alertmanager配置的报警信息的发送规则），用户可以定义基于监控数据的告警规则，规则会触发告警。一旦"),a("code",[s._v("alermanager")]),s._v("收到告警，会通过预定义的方式发出告警通知。")]),s._v(" "),a("li",[s._v("grafana\n这里grafana是监控可视化报表组件。不仅支持prometheus，还支持很多三方数据库，如InfulxDB等。")]),s._v(" "),a("li",[s._v("exporter\nexporter是用来监控应用并采集metric信息的组件统称，负责收集目标对象（host, 容器等…）的性能数据，并通过HTTP接口供 Prometheus Server获取。")]),s._v(" "),a("li",[s._v("pushgateway\npushgateway是数据采用的插件，采用被动推送来获取监控数据，用户可以把把需要监控的数据发送给pushgateway，pushgateway再将数据推送给prometheus server。")])]),s._v(" "),a("h3",{attrs:{id:"部署说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署说明"}},[s._v("#")]),s._v(" 部署说明")]),s._v(" "),a("p",[s._v("这里，prometheus监控告警体系，可以采用二进制，或者容器化的部署方案。为了简化k8s集群监控告警体系的部署和复杂度，CoreOS公司开发了一套Prometheus-Operator的开源方案，用户可以非常简单的在kubernetes集群中部署Prometheus生态服务，通过简单的声明和配置来管理Promtheus实例，这些配置将响应、创建、配置和管理Prometheus监控实例。")]),s._v(" "),a("h4",{attrs:{id:"prometheus-operator原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#prometheus-operator原理"}},[s._v("#")]),s._v(" prometheus-operator原理")]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/monitor/1.png",alt:""}})]),s._v(" "),a("p",[s._v("从本质上来讲Prometheus属于是典型的有状态应用，而其有包含了一些自身特有的运维管理和配置管理方式。而这些都无法通过Kubernetes原生提供的应用管理概念实现自动化。Operator的出现简化了这类应用程序的管理复杂度。它在Kubernetes基本的Resource和Controller的概念上，以扩展Kubernetes api的形式。帮助用户创建，配置和管理复杂的有状态应用程序。从而实现特定应用程序的常见操作以及运维自动化。")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("Operator： 根据自定义资源（Custom Resource Definition / CRDs）来部署和管理 Prometheus Server，同时监控这些自定义资源事件的变化来做相应的处理，是整个系统的控制中心，也就是我们常用的控制器，可见operater让prometheus更加k8s。")])]),s._v(" "),a("li",[a("p",[s._v("Prometheus：声明式创建和管理Prometheus Server实例。")])]),s._v(" "),a("li",[a("p",[s._v("Prometheus Server： Operator根据自定义资源Prometheus类型中定义的内容而部署的Prometheus Server集群，这些自定义资源可以看作是用来管理Prometheus Server集群的 StatefulSets 资源。")])]),s._v(" "),a("li",[a("p",[s._v("ServiceMonitor：声明指定监控的服务，描述了一组被Prometheus监控的目标列表。该资源通过Labels来选取对应的Service Endpoint，让 Prometheus Server通过选取的 Service来获取Metrics信息。")])]),s._v(" "),a("li",[a("p",[s._v("Service：简单的说就是Prometheus监控的对象。")])]),s._v(" "),a("li",[a("p",[s._v("Alertmanager：定义AlertManager deployment期望的状态，Operator确保这个deployment运行时一直与定义保持一致。")])])]),s._v(" "),a("h4",{attrs:{id:"部署和资源实例介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署和资源实例介绍"}},[s._v("#")]),s._v(" 部署和资源实例介绍")]),s._v(" "),a("p",[s._v("这里部署请参考官方文档：https://github.com/prometheus-operator/prometheus-operator")]),s._v(" "),a("ul",[a("li",[s._v("prometheus实例")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@yuhaohao ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get prometheuses.monitoring.coreos.com -n monitoring")]),s._v("\nNAME                    VERSION   DESIRED   READY   RECONCILED   AVAILABLE   AGE\nprometheus-prometheus             "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("       True         True        284d\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@yuhaohao ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod -n monitoring |grep prometheus")]),s._v("\nprometheus-prometheus-prometheus-0               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          51d\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("ul",[a("li",[s._v("servicemonitor 示例配置")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下面以ping-exporter为例，进行了说明servicemonitor和service的配置信息")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@yuhaohao ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get service -n monitoring ping-exporter -o yaml")]),s._v("\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app.kubernetes.io/instance: ping-exporter\n    app.kubernetes.io/name: ping-exporter\n  name: ping-exporter\n  namespace: monitoring\nspec:\n  ports:\n  - name: http\n    port: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9427")]),s._v("\n    protocol: TCP\n    targetPort: http\n  selector:\n    app.kubernetes.io/instance: ping-exporter\n    app.kubernetes.io/name: ping-exporter\n  type: ClusterIP\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@yuhaohao ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat ping-exporter-servicemonitor.yaml")]),s._v("\napiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  labels:\n    app.kubernetes.io/instance: ping-exporter\n    app.kubernetes.io/name: ping-exporter\n  name: ping-exporter\n  namespace: monitoring\nspec:\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定job的标签，可以不设置。")]),s._v("\n  jobLabel: k8s-app\n  endpoints:\n  - honorLabels: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监控数据抓取的时间间隔")]),s._v("\n    interval: 30s\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定metrics端口，这个port对应services.spec.ports.name")]),s._v("\n    port: http\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监控目标Service所在的命名空间")]),s._v("\n  namespaceSelector:\n    matchNames:\n    - monitoring\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 监控目标Service目标的标签。")]),s._v("\n  selector:\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 注意，这个标签要和etcd的service的标签保持一致")]),s._v("\n    matchLabels:\n      app.kubernetes.io/instance: ping-exporter\n      app.kubernetes.io/name: ping-exporter\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br")])]),a("p",[a("img",{attrs:{src:"/img/monitor/3.png",alt:""}})]),s._v(" "),a("p",[s._v("创建servicemonitor完毕后，此时我们查看prometheus的配置(在prometheus的Status->Configuration)可以发现，自动多了一条job_name的配置：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("- job_name: serviceMonitor/monitoring/ping-exporter/0\n  honor_labels: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  honor_timestamps: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  scrape_interval: 30s\n  scrape_timeout: 10s\n  metrics_path: /metrics\n  scheme: http\n  follow_redirects: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  enable_http2: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  relabel_configs:\n  - source_labels: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("job"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    separator: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    regex: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    target_label: __tmp_prometheus_job_name\n    replacement: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n    action: replace\n  - source_labels: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_service_label_app_kubernetes_io_instance, __meta_kubernetes_service_labelpresent_app_kubernetes_io_instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    separator: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    regex: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ping-exporter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n    replacement: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n    action: keep\n  - source_labels: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_service_label_app_kubernetes_io_name, __meta_kubernetes_service_labelpresent_app_kubernetes_io_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    separator: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    regex: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ping-exporter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n    replacement: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n    action: keep\n  - source_labels: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_endpoint_port_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    separator: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    regex: http\n    replacement: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n    action: keep\n  - source_labels: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_endpoint_address_target_kind, __meta_kubernetes_endpoint_address_target_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    separator: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    regex: Node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    target_label: "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\n    replacement: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${1}")]),s._v("\n    action: replace\n  - source_labels: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_endpoint_address_target_kind, __meta_kubernetes_endpoint_address_target_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    separator: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    regex: Pod"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    target_label: pod\n    replacement: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${1}")]),s._v("\n    action: replace\n  - source_labels: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_namespace"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    separator: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    regex: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    target_label: namespace\n    replacement: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n    action: replace\n  - source_labels: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_service_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    separator: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    regex: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    target_label: "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v("\n    replacement: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n    action: replace\n  - source_labels: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_pod_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    separator: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    regex: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    target_label: pod\n    replacement: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n    action: replace\n  - source_labels: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_pod_container_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    separator: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    regex: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    target_label: container\n    replacement: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n    action: replace\n  - source_labels: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_pod_phase"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    separator: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    regex: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Failed"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("Succeeded"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    replacement: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n    action: drop\n  - source_labels: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_service_name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    separator: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    regex: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    target_label: job\n    replacement: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${1}")]),s._v("\n    action: replace\n  - source_labels: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_service_label_jobLabel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    separator: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    regex: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".+"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    target_label: job\n    replacement: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${1}")]),s._v("\n    action: replace\n  - separator: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    regex: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    target_label: endpoint\n    replacement: http\n    action: replace\n  - source_labels: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__address__"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    separator: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    regex: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    modulus: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    target_label: __tmp_hash\n    replacement: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n    action: hashmod\n  - source_labels: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__tmp_hash"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    separator: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    regex: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0"')]),s._v("\n    replacement: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$1")]),s._v("\n    action: keep\n  kubernetes_sd_configs:\n  - role: endpoints\n    kubeconfig_file: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n    follow_redirects: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n    enable_http2: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n    namespaces:\n      own_namespace: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n      names:\n      - monitoring\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br"),a("span",{staticClass:"line-number"},[s._v("94")]),a("br"),a("span",{staticClass:"line-number"},[s._v("95")]),a("br"),a("span",{staticClass:"line-number"},[s._v("96")]),a("br"),a("span",{staticClass:"line-number"},[s._v("97")]),a("br"),a("span",{staticClass:"line-number"},[s._v("98")]),a("br"),a("span",{staticClass:"line-number"},[s._v("99")]),a("br"),a("span",{staticClass:"line-number"},[s._v("100")]),a("br"),a("span",{staticClass:"line-number"},[s._v("101")]),a("br"),a("span",{staticClass:"line-number"},[s._v("102")]),a("br"),a("span",{staticClass:"line-number"},[s._v("103")]),a("br"),a("span",{staticClass:"line-number"},[s._v("104")]),a("br"),a("span",{staticClass:"line-number"},[s._v("105")]),a("br"),a("span",{staticClass:"line-number"},[s._v("106")]),a("br"),a("span",{staticClass:"line-number"},[s._v("107")]),a("br"),a("span",{staticClass:"line-number"},[s._v("108")]),a("br"),a("span",{staticClass:"line-number"},[s._v("109")]),a("br"),a("span",{staticClass:"line-number"},[s._v("110")]),a("br")])]),a("h4",{attrs:{id:"prometheus和servicemonitor关联"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#prometheus和servicemonitor关联"}},[s._v("#")]),s._v(" prometheus和servicemonitor关联")]),s._v(" "),a("p",[s._v("Prometheus与ServiceMonitor之间的关联关系使用serviceMonitorSelector定义，在Prometheus中通过标签选择当前需要监控的ServiceMonitor对象。\nPrometheus的定义如下所示： 为了能够让Prometheus关联到ServiceMonitor，需要在Pormtheus定义中使用serviceMonitorSelector")]),s._v(" "),a("p",[s._v("为空表示可以关联任意命名空间下的标签，下面是具体的示例说明")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@yuhaohao ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get prometheuses.monitoring.coreos.com -n monitoring  -o yaml")]),s._v("\napiVersion: v1\nitems:\n- apiVersion: monitoring.coreos.com/v1\n  kind: Prometheus\n  metadata:\n    annotations:\n      meta.helm.sh/release-name: prometheus\n      meta.helm.sh/release-namespace: monitoring\n    creationTimestamp: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2024-01-15T07:35:18Z"')]),s._v("\n    generation: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n    labels:\n      app.kubernetes.io/component: prometheus\n      app.kubernetes.io/instance: prometheus\n      app.kubernetes.io/managed-by: Helm\n      app.kubernetes.io/name: kube-prometheus\n      app.kubernetes.io/version: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.68")]),s._v(".0\n      helm.sh/chart: kube-prometheus-8.21.2\n    name: prometheus-prometheus\n    namespace: monitoring\n    resourceVersion: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"502245405"')]),s._v("\n    uid: 55ba062e-9397-47b5-aa0c-75f8085a038d\n  spec:\n    affinity:\n      podAntiAffinity:\n        preferredDuringSchedulingIgnoredDuringExecution:\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n    enableAdminAPI: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n    enableRemoteWriteReceiver: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n    evaluationInterval: 30s\n    externalUrl: http://prometheus-prometheus.monitoring:9090/\n    image: bitnami/prometheus:2.47.0-debian-11-r26\n    imagePullSecrets:\n    - name: inner\n    listenLocal: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n    logFormat: logfmt\n    logLevel: info\n    paused: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n    podMetadata:\n      labels:\n        app.kubernetes.io/component: prometheus\n        app.kubernetes.io/name: prometheus\n        prometheus: prometheus-prometheus\n    podMonitorNamespaceSelector: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    podMonitorSelector: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    portName: web\n    probeNamespaceSelector: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    probeSelector: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    replicas: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    retention: 60d\n    routePrefix: /\n    ruleNamespaceSelector: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    ruleSelector:\n      matchLabels:\n        prometheus: alertmanager\n        role-define: alerts\n    scrapeConfigNamespaceSelector: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    scrapeConfigSelector: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    scrapeInterval: 30s\n    securityContext:\n      fsGroup: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001")]),s._v("\n      runAsUser: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001")]),s._v("\n    serviceAccountName: prometheus-prometheus\n    serviceMonitorNamespaceSelector: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    serviceMonitorSelector: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br")])]),a("h3",{attrs:{id:"告警规则管理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#告警规则管理"}},[s._v("#")]),s._v(" 告警规则管理")]),s._v(" "),a("h4",{attrs:{id:"operator管理alertmanager实例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#operator管理alertmanager实例"}},[s._v("#")]),s._v(" operator管理alertmanager实例")]),s._v(" "),a("p",[s._v("通过Prometheus Operator管理Alertmanager实例，用户可以通过自定义资源Alertmanager进行定义，如下所示\n当replicas大于1时，Prometheus Operator会自动通过集群的方式创建Alertmanager:")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@yuhaohao ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get alertmanagers.monitoring.coreos.com -n monitoring -o yaml")]),s._v("\napiVersion: v1\nitems:\n- apiVersion: monitoring.coreos.com/v1\n  kind: Alertmanager\n  metadata:\n    annotations:\n      meta.helm.sh/release-name: prometheus\n      meta.helm.sh/release-namespace: monitoring\n    creationTimestamp: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2024-01-15T07:35:18Z"')]),s._v("\n    generation: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    labels:\n      app.kubernetes.io/component: alertmanager\n      app.kubernetes.io/instance: prometheus\n      app.kubernetes.io/managed-by: Helm\n      app.kubernetes.io/name: kube-prometheus\n      app.kubernetes.io/version: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.68")]),s._v(".0\n      helm.sh/chart: kube-prometheus-8.21.2\n    name: prometheus-alertmanager\n    namespace: monitoring\n    resourceVersion: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"152700636"')]),s._v("\n    uid: 10e4b2e4-4e5d-4a1a-a289-c8a809894060\n  spec:\n    affinity:\n      podAntiAffinity:\n        preferredDuringSchedulingIgnoredDuringExecution:\n        - podAffinityTerm:\n            labelSelector:\n              matchLabels:\n                app.kubernetes.io/component: alertmanager\n                app.kubernetes.io/instance: prometheus\n                app.kubernetes.io/name: kube-prometheus\n            topologyKey: kubernetes.io/hostname\n          weight: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    containers:\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n    externalUrl: http://prometheus-alertmanager.monitoring:9093/\n    image: bitnami/alertmanager:0.26.0-debian-11-r38\n    imagePullSecrets:\n    - name: inner\n    listenLocal: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n    logFormat: logfmt\n    logLevel: info\n    paused: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),s._v("\n    podMetadata:\n      labels:\n        alertmanager: prometheus-alertmanager\n        app.kubernetes.io/component: alertmanager\n        app.kubernetes.io/name: alertmanager\n    portName: web\n    replicas: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    resources: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    retention: 120h\n    routePrefix: /\n    securityContext:\n      fsGroup: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001")]),s._v("\n      runAsUser: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1001")]),s._v("\n    serviceAccountName: prometheus-alertmanager\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br")])]),a("h4",{attrs:{id:"告警规则配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#告警规则配置"}},[s._v("#")]),s._v(" 告警规则配置")]),s._v(" "),a("p",[s._v("在Prometheus Operator模式中，告警规则也编程一个通过Kubernetes API声明式创建的一个资源，如下所示：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@yuhaohao ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat k8s-ping-rules.yaml")]),s._v("\napiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  name: k8s-ping-rules\n  namespace: monitoring\n  labels:\n    prometheus: alertmanager\n    role-define: alerts\nspec:\n  groups:\n    - name: k8s-ping.rules\n      rules:\n        - alert: 节点异常无法连通\n          expr: ping_loss_ratio"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("job"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ping-exporter"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n          for: 1m\n          labels:\n            severity: P0\n          annotations:\n            summary: 集群节点无法连通\n            description: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"k8s集群主机: {{ '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$labels")]),s._v('.target }} Ping Loss, 检查节点是否宕机."')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("p",[s._v("告警规则创建成功后，通过在Prometheus中使用ruleSelector通过选择需要关联的PrometheusRule即可，具体如下：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@yuhaohao ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get prometheuses.monitoring.coreos.com -n monitoring  -o yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\nruleSelector:\n    matchLabels:\n        prometheus: alertmanager\n        role-define: alerts\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("Prometheus重新加载配置后，从UI中我们可以查看到通过PrometheusRule自动创建的告警规则配置：\n"),a("img",{attrs:{src:"/img/monitor/4.png",alt:""}})]),s._v(" "),a("h4",{attrs:{id:"prometheus和alertmanager关联"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#prometheus和alertmanager关联"}},[s._v("#")]),s._v(" prometheus和alertmanager关联")]),s._v(" "),a("p",[s._v("通过在Prometheus中使用alerting指定使用的Alertmanager资源即可")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@yuhaohao ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get prometheuses.monitoring.coreos.com -n monitoring prometheus-prometheus -o yaml")]),s._v("\napiVersion: monitoring.coreos.com/v1\nkind: Prometheus\nmetadata:\n  annotations:\n    meta.helm.sh/release-name: prometheus\n    meta.helm.sh/release-namespace: monitoring\n  creationTimestamp: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2024-01-15T07:35:18Z"')]),s._v("\n  generation: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n  labels:\n    app.kubernetes.io/component: prometheus\n    app.kubernetes.io/instance: prometheus\n    app.kubernetes.io/managed-by: Helm\n    app.kubernetes.io/name: kube-prometheus\n    app.kubernetes.io/version: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.68")]),s._v(".0\n    helm.sh/chart: kube-prometheus-8.21.2\n  name: prometheus-prometheus\n  namespace: monitoring\n  resourceVersion: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"502279004"')]),s._v("\n  uid: 55ba062e-9397-47b5-aa0c-75f8085a038d\nspec:\n  affinity:\n    podAntiAffinity:\n      preferredDuringSchedulingIgnoredDuringExecution:\n      - podAffinityTerm:\n          labelSelector:\n            matchLabels:\n              app.kubernetes.io/component: prometheus\n              app.kubernetes.io/instance: prometheus\n              app.kubernetes.io/name: kube-prometheus\n          topologyKey: kubernetes.io/hostname\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里制定alerting使用指定的Alertmanager资源")]),s._v("\n  alerting:\n    alertmanagers:\n    - name: prometheus-alertmanager\n      namespace: monitoring\n      pathPrefix: /\n      port: http\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br")])]),a("h3",{attrs:{id:"监控告警常用操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#监控告警常用操作"}},[s._v("#")]),s._v(" 监控告警常用操作")]),s._v(" "),a("h4",{attrs:{id:"_1-查看告警规则相关配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-查看告警规则相关配置"}},[s._v("#")]),s._v(" 1.查看告警规则相关配置")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@yuhaohao ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get secrets -n monitoring alertmanager-prometheus-alertmanager -o yaml")]),s._v("\napiVersion: v1\ndata:\n  alertmanager.yaml: "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("Z2xvYmFsOgogIHJlc29sdmVfdGltZW91dDogNW0KcmVjZWl2ZXJzOgotIG5hbWU6IHdlYmhvb2sKICB3ZWJob29rX2NvbmZpZ3M6CiAgLSBzZW5kX3Jlc29sdmVkOiB0cnVlCiAgICB1cmw6IGh0dHA6Ly8xMC4xOTguMy4yNToyNTI1L2FsZXJ0Ci0gbmFtZTogd2ViaG9va3AwCiAgd2ViaG9va19jb25maWdzOgogICOiDogMzBtCg")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v("\nkind: Secret\nmetadata:\n  creationTimestamp: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2024-10-16T03:22:53Z"')]),s._v("\n  name: alertmanager-prometheus-alertmanager\n  namespace: monitoring\n  resourceVersion: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"489955086"')]),s._v("\n  uid: d5b23ac5-1778-42ab-a002-af6d0b0bdd75\ntype: Opaque\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这里告警规则实际上保持在alertmanager-<name-of-alertmanager-object>的secret中，可以对内容进行base64解码查看")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@yuhaohao ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# echo "Z2xvYmFsOgogIHJlc29sdmVfdGltZW91dDogNW0KcmVjZWl2ZXJzOgotIG5hbWU6IHdlYmhvb2sKICB3ZWJob29rX2NvbmZpZ3M6CiAgLSBzZW5kX3Jlc29sdmVkOiB0cnVlCiAgICB1cmw6IGh0dHA6Ly8xMC4xOTguMy4yNToyNTI1L2FsZXJ0Ci0gbmFtZTogd2ViaG9va3AwCiAgd2ViaG9va19jb25maWdzOgogICOiDogMzBtCg==" |base64 -d ')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h4",{attrs:{id:"修改告警规则并应用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改告警规则并应用"}},[s._v("#")]),s._v(" 修改告警规则并应用")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 加解码后的alertmanager的配置导出到文件")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@yuhaohao ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# echo "Z2xvYmFsOgogIHJlc29sdmVfdGltZW91dDogNW0KcmVjZWl2ZXJzOgotIG5hbWU6IHdlYmhvb2sKICB3ZWJob29rX2NvbmZpZ3M6CiAgLSBzZW5kX3Jlc29sdmVkOiB0cnVlCiAgICB1cmw6IGh0dHA6Ly8xMC4xOTguMy4yNToyNTI1L2FsZXJ0Ci0gbmFtZTogd2ViaG9va3AwCiAgd2ViaG9va19jb25maWdzOgogICOiDogMzBtCg==" |base64 -d  >> alertmanager.yaml')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 清理旧的alertmanager secret")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@yuhaohao ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl delete secrets -n monitoring alertmanager-prometheus-alertmanager")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 应用新的alertmanager secret配置")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@yuhaohao ~"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n monitoring create secret generic alertmanager-prometheus-alertmanager  --from-file ./alertmanager.yaml")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);